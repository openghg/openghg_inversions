<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-10-09 Mon 10:00 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inversions how-to</title>
<meta name="author" content="Brendan Murphy" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Inversions how-to</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org7208075">1. Overview</a></li>
<li><a href="#orgf914d03">2. What do you need to run an inversion?</a>
<ul>
<li><a href="#org7a745b2">2.1. Data stored in OpenGHG</a></li>
<li><a href="#org48e3111">2.2. Data not stored in OpenGHG</a></li>
<li><a href="#org41a1bab">2.3. Summary</a></li>
</ul>
</li>
<li><a href="#orgb2ff7cc">3. How do you run an inversion?</a>
<ul>
<li><a href="#org87409a9">3.1. Method 1: python script or notebook</a></li>
<li><a href="#org2286b23">3.2. Method 2: ini file</a></li>
<li><a href="#org941b59c">3.3. Method 3: as a job on Blue Pebble</a></li>
</ul>
</li>
<li><a href="#org0043b31">4. Getting set up on Blue Pebble</a>
<ul>
<li><a href="#org9dd9b3f">4.1. Virtual environment</a></li>
<li><a href="#orga2e3df9">4.2. Example batch job script</a></li>
<li><a href="#org07cbec9">4.3. Work vs. Home directory</a></li>
</ul>
</li>
<li><a href="#org2c9c1da">5. Sample .ini file</a></li>
<li><a href="#orgd95e178">6. Description of HBMCMC output file</a></li>
</ul>
</div>
</div>

<div id="outline-container-org7208075" class="outline-2">
<h2 id="org7208075"><span class="section-number-2">1.</span> Overview</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Countries are required to create &ldquo;bottom-up&rdquo; inventories of emissions. These may be totals for a country, or may be a map of estimated emissions for a given time period.</li>
<li>To check these inventories, we create &ldquo;top-down&rdquo; constraints by passing emissions/flux maps through a physical model and comparing the result with observations. We use a Bayesian model to update the flux maps using the given observation data.</li>
<li>The model is roughly \(\mathrm{obs} \approx \mathrm{sensitivities} \times \mathrm{flux} + \mathrm{baseline} + \mathrm{error}\)</li>
<li>The baseline is calculated by multiplying the flux at the boundaries by a sensivity map for each boundary &ldquo;curtain&rdquo; (NESW).</li>
<li>Disturbances from the baseline are calculated by multiplying a &ldquo;footprint&rdquo; (sensitivities for fluxes) times a flux map.</li>
<li>The sensitivities are considered deterministic, and the fluxes and boundary conditions are modelled as random quantities</li>
<li>We place prior distributions on the fluxes and boundary conditions and use the observation data and MCMC to sample from their posterior distributions. (These are specified by the <code>xprior</code> and <code>bcprior</code> variables in the .ini file below.)</li>
<li>Roughly, an inversion attempts to solve \(\mathrm{obs} - \mathrm{baseline} \approx \mathrm{sensitivities} \times \mathrm{flux}\); the sensitivity matrix is not invertible, so a method like least-squares is necessary. We use a hierarchical Bayesian regression approach, which estimates uncertainties in a natural way.</li>
<li>The output of an inversion contains prior and posterior: modelled observations (&ldquo;\(Y\)&rdquo; variables), fluxes, and boundary conditions.</li>
</ul>
</div>
</div>


<div id="outline-container-orgf914d03" class="outline-2">
<h2 id="orgf914d03"><span class="section-number-2">2.</span> What do you need to run an inversion?</h2>
<div class="outline-text-2" id="text-2">
<p>
For an inversion, you need to decide the:
</p>
<ul class="org-ul">
<li>gas species (currently you can only choose one)</li>
<li>sites (how many, which sites)</li>
<li>time period (specified using <code>start_date</code>, <code>end_date</code>)</li>
<li>domain for inversion (for sites in the UK, this is usually <code>'EUROPE'</code>)</li>
</ul>

<p>
Once you know the rough outline of your inversion, you need to make sure the right data is stored in OpenGHG, and you will need a few extra files not stored in OpenGHG.
</p>
</div>

<div id="outline-container-org7a745b2" class="outline-3">
<h3 id="org7a745b2"><span class="section-number-3">2.1.</span> Data stored in OpenGHG</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>Observation data: stored using <code>standardise_surface</code>; look for it using <code>search_surface</code>. You need observation data for each site.</li>
<li>Flux data: stored using <code>standardise_flux</code>; look for it using <code>search_flux</code>.</li>
<li>Boundary conditions data: stored using <code>standardise_bc</code>; look for it using <code>search_bc</code>.</li>
<li>Footprints: stored using <code>standardise_footprint</code>; look for it using <code>search_footprints</code> (NOTE: footprint(s) is plural for search, singular for standardise). You need separate footprints for each site.</li>
</ul>

<p>
NOTE: flux and boundary conditions data usually has a specific <i>domain</i>, but it is not specific to any one measurement site, so for multiple sites, you will usually use the same flux and boundary conditions.
</p>
</div>
</div>

<div id="outline-container-org48e3111" class="outline-3">
<h3 id="org48e3111"><span class="section-number-3">2.2.</span> Data not stored in OpenGHG</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>countries file
<ul class="org-ul">
<li>e.g. <code>country_EUROPE.nc</code></li>
<li>default location is <code>openghg_inversions/countries</code></li>
</ul></li>
<li>basis functions
<ul class="org-ul">
<li>&ldquo;basis function&rdquo; usually means a netCDF file with latitude and longitude coordinates, with integer values. So all of the coordinates with value 1 are in region 1, and so on.</li>
<li>basis functions for fluxes are created on the fly by a &ldquo;quadtree basis&rdquo; algorithm. You can also read in pre-defined basis functions. Default location: <code>openghg_inversions/basis_functions</code></li>
<li>basis functions for the boundary conditions have a similar format. Defaul location <code>openghg_inversions/bc_basis_functions</code></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org41a1bab" class="outline-3">
<h3 id="org41a1bab"><span class="section-number-3">2.3.</span> Summary</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>basis functions (for flux) are created on the fly, or you can provide them; you need to provide a country file and bc\<sub>basis</sub>\<sub>functions</sub> files.</li>
<li>all of these files can be found in <code>/group/chemistry/acrg/LPDM</code>.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgb2ff7cc" class="outline-2">
<h2 id="orgb2ff7cc"><span class="section-number-2">3.</span> How do you run an inversion?</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org87409a9" class="outline-3">
<h3 id="org87409a9"><span class="section-number-3">3.1.</span> Method 1: python script or notebook</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Assuming you have the necessary data, you just need to run the <code>fixedbasisMCMC</code> function from <code>hbmcmc.py</code> in <code>openghg_inversions.hbmbmc</code>.
</p>
</div>
</div>

<div id="outline-container-org2286b23" class="outline-3">
<h3 id="org2286b23"><span class="section-number-3">3.2.</span> Method 2: ini file</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Create a <code>.ini</code> file based on the templates in <code>openghg_inversions/config/templates</code>. (NOTE: these need to be updated.)</li>
<li>Activate a conda or venv environment with inversions installed, and call <code>python &lt;path to openghg_inversions&gt;/openghg_inversions/hbmcmc/run_hbmcmc.py -c somefile.ini</code></li>
<li>A sample <code>.ini</code> script is at the bottom of this document.</li>
</ul>
</div>
</div>

<div id="outline-container-org941b59c" class="outline-3">
<h3 id="org941b59c"><span class="section-number-3">3.3.</span> Method 3: as a job on Blue Pebble</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>Create a <code>.sh</code> file to run a <a href="https://www.acrc.bris.ac.uk/protected/hpc-docs/job_types/serial.html">batch job using SLURM</a> using <code>sbatch</code>.</li>
<li>This file will specify:
<ul class="org-ul">
<li>the name of the job</li>
<li>resources required (number of nodes, number of tasks per node, number of cpus per task, memory required, compute time required). Typically, you need 1 node, 1 task, and as many cpus per task as chains in your inversion (each chain is an indepedent MCMC process; using 4 is best for checking convergence)</li>
<li>where terminal output and errors should be written</li>
<li>shell commands to run on the compute node:
<ul class="org-ul">
<li>commands to activate your virtual environment</li>
<li>commands to run an inversion (usually method 2, but you could use method 1 in a python script)</li>
</ul></li>
</ul></li>
<li>On the blue pebble login node, run <code>sbatch my_inversion_script.sh</code> (replace <code>'my_inversion_script'</code> with whatever your script is called).</li>
<li>Use the command <code>sacct</code> to see what batch jobs you have running.</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org0043b31" class="outline-2">
<h2 id="org0043b31"><span class="section-number-2">4.</span> Getting set up on Blue Pebble</h2>
<div class="outline-text-2" id="text-4">
<p>
This is assuming you can ssh into blue pebble, and are able to modify files and run commands there (either on the terminal or through VS code or similar).
</p>
</div>

<div id="outline-container-org9dd9b3f" class="outline-3">
<h3 id="org9dd9b3f"><span class="section-number-3">4.1.</span> Virtual environment</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>Blue pebble has pre-installed software called &ldquo;modules&rdquo;.
<ul class="org-ul">
<li><code>module avail</code> shows available modules</li>
<li><code>module load ...</code> will load a module</li>
</ul></li>
<li>Typically you will use the latest anaconda module: <code>module load lang/python/anaconda</code>.</li>
<li>To make your own environment for <code>openghg_inversions</code>, you should:
<ol class="org-ol">
<li>make a conda env <code>conda create --name inv_env numpy</code> (note: installing <code>numpy</code> from <code>conda</code> will install <code>openblas</code>, which is a fast linear algebra library; these libraries are in non-standard locations on Blue Pebble, and <code>pip install numpy</code> will not find them.)</li>
<li>clone openghg<sub>inversions</sub>: <code>git clone https://github.com/openghg/openghg_inversions.git</code></li>
<li><code>pip install openghg_inversions</code> (in the same directory where you just cloned <code>openghg_inversions</code>)</li>
</ol></li>
</ul>
</div>
</div>




<div id="outline-container-orga2e3df9" class="outline-3">
<h3 id="orga2e3df9"><span class="section-number-3">4.2.</span> Example batch job script</h3>
<div class="outline-text-3" id="text-4-2">
<p>
This script assumes that you have already created a conda env called <code>pymc_env</code> and you have an <code>.ini</code> file in a folder called <code>my_inversions</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #5B6268;">#</span><span style="color: #5B6268;">!/bin/</span><span style="color: #51afef;">sh</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">****************************************************************************</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Wrapper script for submitting jobs on ACRC HPC</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">docs: https://www.acrc.bris.ac.uk/protected/hpc-docs/index.html</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">****************************************************************************</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --job-name=my_inv</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --output=openghg_inversions.out</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --error=openghg_inversions.err</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --nodes=1</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --ntasks-per-node=1</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --cpus-per-task=4</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --time=04:00:00</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --mem=30gb</span>
<span style="color: #5B6268;">#</span><span style="color: #5B6268;">SBATCH --account=chem007981</span>


<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Set up Python environment</span>
module load lang/python/anaconda
<span style="color: #c678dd;">eval</span> <span style="color: #98be65;">"</span><span style="color: #51afef; font-weight: bold;">$(</span><span style="color: #51afef; font-weight: bold;">conda shell.bash hook</span><span style="color: #51afef; font-weight: bold;">)</span><span style="color: #98be65;">"</span>
conda activate pymc_env

<span style="color: #5B6268;">#</span><span style="color: #5B6268;">conda info</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">run inversion script</span>
<span style="color: #dcaeea;">INI_FILE</span>=/user/home/bm13805/my_inversions/my_hbmcmc_inputs.ini
python /user/home/bm13805/openghg_inversions/openghg_inversions/hbmcmc/run_hbmcmc.py -c $<span style="color: #dcaeea;">INI_FILE</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">check numpy config</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">python -c "import numpy as np; np.show_config()"</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">python -c "import pymc"</span>

</pre>
</div>

<p>
If this script is saved as <code>my_inversions_script.sh</code>, you would run it with <code>sbatch my_inversion_script.sh</code>.
</p>

<p>
If you comment out the lines under <code># run inversion script</code> and uncomment the lines under <code># check numpy config</code>, you can check if numpy is using a fast linear algebra library. If you are <b>not</b> using a fast linear algebra library, then in the <code>.err</code> output file you will see the warning <code>WARNING (pytensor): Using NumPy C-API based implementation for BLAS functions.</code>. Your inversion will run much slower if this is the case; try using conda to install numpy before installing openghg<sub>inversions</sub>, as mentioned above.
</p>
</div>
</div>


<div id="outline-container-org07cbec9" class="outline-3">
<h3 id="org07cbec9"><span class="section-number-3">4.3.</span> Work vs. Home directory</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>Your home directory <code>/user/home/ab12345</code> (replace ab12345 with your using name) has a storage quota of 25GB.</li>
<li>Check you usage with command <code>user-quota</code>.</li>
<li>Your work directory <code>/user/work/ab12345</code> has a storage quota of 1000GB.</li>
<li>Conda environments and the inversion output files can be quite large, so if you are doing many inversions, you should put the output directory in your work directory. (And if you are making multiple conda environments, you should put them in your work directory as well.)</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org2c9c1da" class="outline-2">
<h2 id="org2c9c1da"><span class="section-number-2">5.</span> Sample .ini file</h2>
<div class="outline-text-2" id="text-5">
<p>
The following file, <code>sample_input.ini</code> can be used to run an
</p>

<div class="org-src-container">
<pre class="src src-toml">; Configuration file for HBMCMC code
; Required inputs are marked as such.
; All other inputs are optional (defaults will be used)

[<span style="color: #ECBE7B;">INPUT.MEASUREMENTS</span>]
; Input values for extracting observations
; species (str) - species name,  e.g. <span style="color: #98be65;">"ch4"</span>, <span style="color: #98be65;">"co2"</span>, <span style="color: #98be65;">"n2o"</span>, etc.
; sites (list) - site codes as a list, e.g. [<span style="color: #98be65;">"TAC"</span>, <span style="color: #98be65;">"MHD"</span>]
; meas_period (list) - Time periods for measurements as a list (must match length of sites)
; start_date (str) - Start of observations to extract (format YYYY-MM-DD)
; end_date (str) - End of observations to extract (format YYYY-MM-DD) (non-inclusive)
; inlet (list/None) - Specific inlet height for the site (list - must match number of sites)
; instrument (list/None) - Specific instrument for the site (list - must match number of sites)

<span style="color: #dcaeea;">species</span>     = <span style="color: #98be65;">'ch4'</span>   ; (required)
<span style="color: #dcaeea;">sites</span>       = [<span style="color: #98be65;">'TAC'</span>] ; (required)
<span style="color: #dcaeea;">meas_period</span> = [<span style="color: #98be65;">'1H'</span>]  ; (required)
<span style="color: #dcaeea;">start_date</span>  = <span style="color: #98be65;">'2019-01-01'</span>      ; (required)
<span style="color: #dcaeea;">end_date</span>    = <span style="color: #98be65;">'2019-02-01'</span>      ; (required)
<span style="color: #dcaeea;">inlet</span>         = [<span style="color: #98be65;">"185m"</span>]
<span style="color: #dcaeea;">instrument</span>    = [<span style="color: #98be65;">"picarro"</span>]


[<span style="color: #ECBE7B;">INPUT.PRIORS</span>]
; Input values for extracting footprints, emissions and boundary conditions files (also uses values from INPUT.MEASUREMENTS)
; domain (str) - Name of inversion spatial domain
; fp_height (list) - Release height for footprints (must match number of sites).
; emissions_name (list/None) - Name for specific emissions source.

<span style="color: #dcaeea;">domain</span> = <span style="color: #98be65;">'EUROPE'</span>  ; (required)
<span style="color: #dcaeea;">fp_height</span> = [<span style="color: #98be65;">"185m"</span>]  ; typically the same as inlet, but may differ slightly (e.g. if instrument moved to 180m, for instance)
<span style="color: #dcaeea;">fp_model</span> = <span style="color: #98be65;">"NAME"</span>  ; LPDM model, usually NAME
<span style="color: #dcaeea;">emissions_name</span> = [<span style="color: #98be65;">"total-ukghg-edgar7"</span>]  ; total = all emissions sources; agric-ukghg-edgar7 would be agricultural sources only
<span style="color: #dcaeea;">met_model</span> = <span style="color: #98be65;">'UKV'</span>  ; or None if not specified, check the metadata for your footprint

[<span style="color: #ECBE7B;">INPUT.BASIS_CASE</span>]
; Input values to extract the basis cases to use within the inversion for boundary conditions and emissions/fluxes
; bc_basis_case (str) - boundary conditions basis, defaults to <span style="color: #98be65;">"NESW"</span> (looks for file format {bc_basis_case}_{domain}_*.nc)
; fp_basis_case (str/None) - emissions bases:
; - if specified, looks for file format {fp_basis_case}_{domain}_*.nc
; - if None, creates basis function using quadtree algorithm and associated parameters
;   - nbasis - Number of basis functions to use for quadtree derived basis function (rounded to %4)

<span style="color: #dcaeea;">bc_basis_case</span>  = <span style="color: #98be65;">"NESW"</span>
<span style="color: #dcaeea;">bc_basis_directory</span> = <span style="color: #98be65;">"/group/chemistry/acrg/LPDM/bc_basis_functions/"</span>  ; LPDM/bc_basis_functions is default
<span style="color: #dcaeea;">fp_basis_case</span>  = None ;  do not read in a basis for footprint/flux
<span style="color: #dcaeea;">quadtree_basis</span> = <span style="color: #51afef;">True</span> ; create quadtree basis on the fly
<span style="color: #dcaeea;">nbasis</span>         = <span style="color: #da8548; font-weight: bold;">100</span> ; number of basis functions to use
<span style="color: #dcaeea;">basis_directory</span> = <span style="color: #98be65;">"/group/chemistry/acrg/LPDM/basis_functions/"</span>
<span style="color: #dcaeea;">country_file</span> = None

[<span style="color: #ECBE7B;">MCMC.TYPE</span>]
; Which MCMC setup to use. This defines the function which will be called and the expected inputs.
; Options include: <span style="color: #98be65;">"fixed_basis"</span>

<span style="color: #dcaeea;">mcmc_type</span> = <span style="color: #98be65;">"fixed_basis"</span>


[<span style="color: #ECBE7B;">MCMC.PDF</span>]
; Definitions of PDF shape and parameters for inputs
; - xprior (dict) - emissions
; - bcprior (dict) - boundary conditions
; - sigprior (dict) - model error

; Each of these inputs should be dictionary with the name of probability distribution and shape parameters.
; See https://docs.pymc.io/api/distributions/continuous.html
; Check openghg_inversions.hbmcmc.inversion_pymc for options.

<span style="color: #dcaeea;">xprior</span>   = {<span style="color: #98be65;">"pdf"</span>:<span style="color: #98be65;">"lognormal"</span>, <span style="color: #98be65;">"mu"</span>:<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #98be65;">"sigma"</span>:<span style="color: #da8548; font-weight: bold;">1</span>}  ; lognormal with mode = <span style="color: #da8548; font-weight: bold;">1</span>, mean = exp(<span style="color: #da8548; font-weight: bold;">1.5</span>)
<span style="color: #dcaeea;">bcprior</span>  = {<span style="color: #98be65;">"pdf"</span>:<span style="color: #98be65;">"lognormal"</span>, <span style="color: #98be65;">"mu"</span>:<span style="color: #da8548; font-weight: bold;">0.004</span>, <span style="color: #98be65;">"sigma"</span>:<span style="color: #da8548; font-weight: bold;">0.02</span>}  ; lognormal with mode = <span style="color: #da8548; font-weight: bold;">1</span>, mean = exp(<span style="color: #da8548; font-weight: bold;">0.006</span>)
<span style="color: #dcaeea;">sigprior</span> = {<span style="color: #98be65;">"pdf"</span>:<span style="color: #98be65;">"uniform"</span>, <span style="color: #98be65;">"lower"</span>:<span style="color: #da8548; font-weight: bold;">0.5</span>, <span style="color: #98be65;">"upper"</span>:<span style="color: #da8548; font-weight: bold;">10</span>}


[<span style="color: #ECBE7B;">MCMC.BC_SPLIT</span>]
; Boundary conditions setup
; - bc_freq - The period over which the baseline is estimated. e.g.
;  - None - one scaling for the whole inversion
;  - <span style="color: #98be65;">"monthly"</span> - per calendar monthly
;  - <span style="color: #98be65;">"*D"</span> (e.g. <span style="color: #98be65;">"30D"</span>) - per number of days (e.g. <span style="color: #da8548; font-weight: bold;">30</span> days)

<span style="color: #dcaeea;">bc_freq</span>    = <span style="color: #98be65;">"monthly"</span>
<span style="color: #dcaeea;">sigma_freq</span> = None


[<span style="color: #ECBE7B;">MCMC.ITERATIONS</span>]
; Iteration parameters
; nit (int) - Number of iterations for MCMC
; burn (int) - Number of iterations to burn in MCMC
; tune (int) - Number of iterations to use to tune step size

<span style="color: #dcaeea;">nit</span>  = <span style="color: #da8548; font-weight: bold;">5000</span>
<span style="color: #dcaeea;">burn</span> = <span style="color: #da8548; font-weight: bold;">1000</span>
<span style="color: #dcaeea;">tune</span> = <span style="color: #da8548; font-weight: bold;">2000</span>


[<span style="color: #ECBE7B;">MCMC.NCHAIN</span>]
; Number of chains to run simultaneously. Must be at least <span style="color: #da8548; font-weight: bold;">2</span> to allow convergence to be checked.

<span style="color: #dcaeea;">nchain</span> = <span style="color: #da8548; font-weight: bold;">4</span>

[<span style="color: #ECBE7B;">MCMC.ADD_ERROR</span>]
; Add variability in averaging period to the measurement error

<span style="color: #dcaeea;">averagingerror</span> = <span style="color: #51afef;">False</span>

[<span style="color: #ECBE7B;">MCMC.OUTPUT</span>]
; Details of where to write the output
; outputpath (str) - directory to write output
; outputname (str) - unique identifier for output/run name.

<span style="color: #dcaeea;">outputpath</span> = <span style="color: #98be65;">'/user/work/ab12345/my_inversions'</span>  ; (required)
<span style="color: #dcaeea;">outputname</span> = <span style="color: #98be65;">'ch4_TAC_test'</span>  ; (required)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd95e178" class="outline-2">
<h2 id="orgd95e178"><span class="section-number-2">6.</span> Description of HBMCMC output file</h2>
<div class="outline-text-2" id="text-6">
<p>
The output of <code>run_hbmcmc</code> (and <code>fixedbasisMCMC</code>) is an xarray Dataset with the following variables and attributes:
</p>

<p>
HMCMC output data variables:
</p>
<ul class="org-ul">
<li><code>Y</code>: Measurements used in inversion</li>
<li><code>Yerror</code>: Measurement error</li>
<li><code>Ytime</code>: Measurement times</li>
<li><code>Yapriori</code>: Modelled measurements using a priori emissions</li>
<li><code>Ymod</code>: Posterior modelled mean measurements</li>
<li><code>Ymod95</code>: Posterior modelled 95% measurement uncertainty (2.5% and 97.5%)</li>
<li><code>Ymod68</code>: Posterior modelled 68% measurement uncertainty (16% and 84%)</li>
<li><code>YmodBC</code>: Posterior modelled mean boundary conditions</li>
<li><code>YaprioriBC</code>: Modelled BCs using a priori BCs</li>
<li><code>xtrace</code>: MCMC chain for basis functions</li>
<li><code>bctrace</code>: MCMC chain for boundary conditions</li>
<li><code>sigtrace</code>: MCMC chain for model error (currently iid)</li>
<li><code>siteindicator</code>: numerical value corresponding to each site, same size as Y.</li>
<li><code>sitename</code>: name of site (in order or siteindicators)</li>
<li><code>site_lon</code>: Measurement site longitude</li>
<li><code>site_lat</code>: Measurement site latitude</li>
<li><code>aprioriflux</code>: Mean a priori flux for whole domain at NAME resolution. E.g.., if emissions file is monthly, and you are running for April and May it will take the mean emissions weighted by number of days in each month.</li>
<li><code>meanflux</code>: Mean posterior flux for whole domain at NAME resolution</li>
<li><code>meanscaling</code>: Mean posterior scaling for whole domain at NAME resolution</li>
<li><code>basis_functions</code>: Basis functions used at NAME resolution</li>
<li><code>countrytotals</code>: Mean posterior total emissions for every country in domain country file</li>
<li><code>country68</code>: 68% uncertainty for country totals (16% and 84%)</li>
<li><code>country95</code>: 95% uncertainty for country totals (2.5% and 97.5%)</li>
<li><code>countrysd</code>: standard deviation for country totals</li>
</ul>

<p>
Attributes:
</p>
<ul class="org-ul">
<li>Units for all variables that need them</li>
<li>Start date of inversion period</li>
<li>End date of inversion period</li>
<li>Type(s) of MCMC sampler used</li>
<li>Prior PDF for emissions scaling</li>
<li>Prior PDF for BC scaling</li>
<li>Prior PDF for model error</li>
<li>Creator</li>
<li>Date created</li>
<li>Convergence: Passed/Failed based on multiple chains (min 2) having Gelman-Rubin diagnostic &lt; 1.05</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Brendan Murphy</p>
<p class="date">Created: 2023-10-09 Mon 10:00</p>
</div>
</body>
</html>